---
- hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Full system upgrade
      community.general.pacman:
        update_cache: true
        upgrade: true

    - name: Install packages
      community.general.pacman:
        name:
          - networkmanager
          - man
          - reflector # pacman mirror optimizer
          - curl
          - wget
          - unzip
          - ntp # system time
          - htop
          - fastfetch # show system info
          - vim
          - neovim
          - ttf-meslo-nerd
          - ttf-nerd-fonts-symbols
          - openssh
          - tlp # battery life optimizer
          - tmux
        state: present
      become: true




    # CONFIGURE SERVICES
    - name: Enable network manager service
      ansible.builtin.systemd:
        name: NetworkManager
        enabled: true
        state: started
      become: true

    - name: Enable tlp power saving
      ansible.builtin.systemd:
        name: tlp
        enabled: true
        state: started
      become: true

    - name: Enable time sync
      ansible.builtin.systemd:
        name: systemd-timesyncd
        enabled: true
        state: started
      become: true
      notify:
        - Setup ntp




    # FIREWALL
    - name: Install firewall
      community.general.pacman:
        name:
          - ufw
        state: present
      become: true

    - name: Deny all incoming traffic
      ufw:
        rule: deny
        direction: in
      become: true

    - name: Allow all outgoing traffic
      ufw:
        rule: allow
        direction: out
      become: true

    - name: Enable UFW systemd service
      ansible.builtin.systemd:
        name: ufw
        enabled: true
        state: started
      become: true



    # SWAY WAYLAND DISPLAY MANAGER
    - name: Install packages for sway
      community.general.pacman:
        name:
          - polkit
          - sway
          - swayidle
          - swaylock
          - swaybg
          - wmenu
          - foot
          - fuzzel
          - wl-clipboard
          - xdg-desktop-portal-wlr # for screen sharing
        state: present
      become: true



    # EXTRA PACKAGES
    - name: Install extra convencience packages
      community.general.pacman:
        name:
          - noto-fonts
          - firejail
          - firefox
          - papirus-icon-theme
          - base-devel
          - git
          - go
          - make
          - chromium
          - tree
        state: present
      become: true


    # CONFIGURE AUR
    #
    # Check if paru is already installed
    - name: Check if paru is installed
      stat:
        path: /usr/bin/paru
      register: paru_installed

    - name: Clone paru AUR repository
      git:
        repo: https://aur.archlinux.org/paru.git
        dest: /tmp/paru
        clone: yes
        update: yes
      when: not paru_installed.stat.exists

    - name: Build and install paru using makepkg
      shell: |
        cd /tmp/paru
        makepkg -si --noconfirm
      args:
        creates: /usr/bin/paru
      when: not paru_installed.stat.exists

    - name: Clean up paru source directory
      file:
        path: /tmp/paru
        state: absent
      when: not paru_installed.stat.exists


    # CONFIGURE USER ACCESS
    - name: Add user to groups
      ansible.builtin.user:
        name: "{{ ansible_env.USER }}"
        groups: wheel,audio
        append: true
      become: true

    - name: Add wheel to sudoers
      ansible.builtin.copy:
        dest: /etc/sudoers.d/wheel
        content: |
          %wheel ALL=(ALL:ALL) ALL
        owner: root
        group: root
        mode: '0440'
      become: true

    - name: Ensure user directories exist
      file:
        path: "/home/{{ ansible_env.USER }}/{{ item }}"
        state: directory
        mode: "0700"
        owner: "{{ ansible_env.USER }}"
        group: "{{ ansible_env.USER }}"
      become: true
      become_user: "{{ ansible_env.USER }}"
      loop:
        - ".config"
        - "Downloads"
        - "Documents"


    # MICROCODE UPDATES
    - name: Get CPU information
      command: lscpu
      register: lscpu
      changed_when: false

    - name: Install microcode package for Intel CPUs
      pacman:
        name: intel-ucode
      when: "'GenuineIntel' in lscpu.stdout"
      become: true
      notify: Generate initramfs

    - name: Install microcode package for AMD CPUs
      pacman:
        name: amd-ucode
      when: "'AuthenticAMD' in lscpu.stdout"
      become: true
      notify: Generate initramfs



    # NEOVIM
    - name: Install packages for neovim config
      community.general.pacman:
        name:
          - ripgrep
          - npm
          - nodejs
          - ttf-meslo-nerd
        state: present
      become: true
      register: register_package

    - name: Update font cache
      command: fc-cache -f -v
      become: true
      when: register_package.changed


    # SSH
    - name: Create user .ssh directory
      file:
        path: "/home/{{ ansible_env.USER }}/.ssh"
        state: directory
        mode: "0700"
        owner: "{{ ansible_env.USER }}"
        group: "{{ ansible_env.USER }}"
      become: true
      become_user: "{{ ansible_env.USER }}"

    - name: Generate ssh key-pair
      community.crypto.openssh_keypair:
        path: "/home/{{ ansible_env.USER }}/.ssh/id_ed25519"
        type: "ed25519"
      become: true
      become_user: "{{ ansible_env.USER }}"

    - name: Disable SSH service
      ansible.builtin.systemd:
        name: sshd
        enabled: false
        state: stopped
      become: true

    - name: Disable SSH in config
      ansible.builtin.blockinfile:
        path: /etc/ssh/ssh_config
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        block: |
          PermitRootLogin no
          PasswordAuthentication no
          PubkeyAuthentication no
          DenyUsers *
        state: present
        create: false
        mode: "0640"
        owner: "root"
        group: "root"
      become: true


    # KERNEL HARDENING
    - name: Harden kernel
      ansible.builtin.blockinfile:
        path: /etc/sysctl.d/99-hardening.conf
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        block: |
          # protect against SYN flood attacks
          net.ipv4.tcp_syncookies=1

          # protects against time-wait assassination by dropping RST packets for sockets in the time-wait state
          net.ipv4.tcp_rfc1337=1

          # disable commonly exploited SACK
          net.ipv4.tcp_sack=0
          net.ipv4.tcp_dsack=0
          net.ipv4.tcp_fack=0

          # do not leak system time
          net.ipv4.tcp_timestamps=0

          # ignore all ICMP requests to avoid Smurf attacks,
          # make device enumeration more difficult,
          # prevent clock fingerprinting through ICMP timestamps
          net.ipv4.icmp_echo_ignore_all=1

          # enable source validation to protect against IP spoofing
          net.ipv4.conf.all.rp_filter=1
          net.ipv4.conf.default.rp_filter=1

          # disable ICMP redirect acceptance to prevent man in middle
          net.ipv4.conf.all.accept_redirects=0
          net.ipv4.conf.default.accept_redirects=0
          net.ipv4.conf.all.secure_redirects=0
          net.ipv4.conf.default.secure_redirects=0
          net.ipv6.conf.all.accept_redirects=0
          net.ipv6.conf.default.accept_redirects=0
          net.ipv4.conf.all.send_redirects=0
          net.ipv4.conf.default.send_redirects=0

          # disable source routing to disable network traffic redirect
          net.ipv4.conf.all.accept_source_route=0
          net.ipv4.conf.default.accept_source_route=0
          net.ipv6.conf.all.accept_source_route=0
          net.ipv6.conf.default.accept_source_route=0

          # disable ipv6 router advertising
          net.ipv6.conf.all.accept_ra=0
          net.ipv6.conf.default.accept_ra=0

          # disables debugfs to prevent exposing sensitive kernel information
          debugfs=off

          # disables obsolete vsyscalls
          vsyscall=none

          # Protect kernel pointers from unprivileged users
          kernel.kptr_restrict = 1

          # Restrict ptrace to own processes (prevents process snooping)
          kernel.yama.ptrace_scope = 1

          # Filesystem
          fs.suid_dumpable = 0
          fs.protected_hardlinks = 1
          fs.protected_symlinks = 1
          fs.protected_fifos = 2
          fs.protected_regular = 2

        state: present
        create: true
        mode: "0600"
        owner: root
        group: root
      become: true


    - name: Configure journald log size
      ansible.builtin.lineinfile:
        path: /etc/systemd/journald.conf
        line: "SystemMaxUse=100M"
        state: present
        regexp: "^#SystemMaxUse="
      become: true
      notify: Restart journald



    # KUBERNETES
    - name: Install k8s packages
      pacman:
        name:
          - docker
          - kubectl
          - helm
          - minikube
          - bash-completion
        state: present
      become: true

    - name: Ensure group docker exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: true
      become: true
      notify: Restart docker

    # CONFIGURE ROOTLESS DOCKER
    # (!) without, user can escalate to host root
    # https://wiki.archlinux.org/title/Docker#Rootless_Docker_daemon
    - name: Ensure subuid entry exists for rootless user
      ansible.builtin.lineinfile:
        path: /etc/subuid
        line: "{{ ansible_user_id }}:100000:65536"
        regexp: "^{{ ansible_user_id }}:"
        create: yes
        state: present
      become: true

    - name: Ensure subgid entry exists for rootless user
      ansible.builtin.lineinfile:
        path: /etc/subgid
        line: "{{ ansible_user_id }}:100000:65536"
        regexp: "^{{ ansible_user_id }}:"
        create: yes
        state: present
      become: true

    - name: Install docker-rootless using yay
      command: yay -S --noconfirm docker-rootless-extras
      become: true
      environment:
        LANG: "en_US.UTF-8"

    - name: Enable Docker rootless service as user unit
      ansible.builtin.command:
        cmd: "systemctl --user enable docker.service"

    - name: Create persistent Docker rootless context
      ansible.builtin.command:
        cmd: >
          docker context create rootless
          --description "Rootless mode" 
          --docker "host=unix:///run/user/{{ lookup('ansible.builtin.env','UID') }}/docker.sock"

    - name: Set Docker rootless context
      ansible.builtin.command:
        cmd: "docker context use rootless"

    - name: Enable user lingering for docker to start Docker user unit at boot time
      ansible.builtin.command:
        cmd: loginctl enable-linger "{{ ansible_env.USER }}"


    # CONFIGURE AUDIT TOOLS
    - name: Install security packages
      community.general.pacman:
        name:
          # scanning
          - rkhunter
          - clamav
          # system audit
          - lynis
          # audit logging
          - audit
          # apparmor
          - apparmor
          - python-notify2
          - python-psutil
          # usb guard
          - usbguard
          # vpn
          - openvpn
        state: present
      become: true

    # ssh
    - name: Disable password SSH login
      ansible.builtin.blockinfile:
        path: /etc/rkhunter.conf
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        block: |
          # outdated commands that have been replaced by shell scripts
          SCRIPTWHITELIST=/usr/bin/egrep
          SCRIPTWHITELIST=/usr/bin/fgrep
          SCRIPTWHITELIST=/usr/bin/ldd

          # systemd files
          ALLOWHIDDENFILE=/etc/.updated
          ALLOWHIDDENFILE=/usr/share/man/man5/.k5identity.5.gz
          ALLOWHIDDENFILE=/usr/share/man/man5/.k5login.5.gz

        state: present
        create: false
        mode: "0600"
        owner: "root"
        group: "root"
      become: true


    # hibernate
    - name: Create hibernate config dir
      file:
        path: "/etc/systemd/sleep.conf.d"
        state: directory
        mode: "0750"
        owner: "root"
        group: "root"
      become: true
    - name: Disable system hibernate for LUKS encryption compatability
      ansible.builtin.copy:
        dest: /etc/systemd/sleep.conf.d/sleep.conf
        content: |
          [Sleep]
          AllowSuspend=yes
          AllowHibernation=no
          AllowHybridSleep=no
          AllowSuspendThenHibernate=no
        owner: root
        group: root
        mode: '0640'
      become: true


    # PAM lockout
    - name: Configure PAM base package lockout behaviour
      # unlock after failed attempts: faillock --user username --reset
      ansible.builtin.copy:
        dest: /etc/security/faillock.conf
        content: |
          deny=4                  # limited tries
          unlock_time=3600        # 1h lock
          even_deny_root=true     # root is already locked with passwd --lock root, extra measure
          fail_interval=900       # only count failures within 15 min
          dir=/var/lib/faillock   # persist reboots
        owner: root
        group: root
        mode: '0640'
      become: true

    # PAM limits
    - name: Create PAM config dir
      file:
        path: "/etc/security/limits.d"
        state: directory
        mode: "0750"
        owner: "root"
        group: "root"
      become: true
    - name: Configure PAM limits
      become: true
      ansible.builtin.copy:
        dest: /etc/security/limits.d/99-dev.conf
        owner: root
        group: root
        mode: '0640'
        content: |
          *           soft    priority   0            # Neutral niceness
          *           hard    nproc      4096         # Prevent fork-bombs
          root        hard    nproc      65536        # Allow root to spawn many processes
          *           hard    nofile     65535        # Open file descriptors limit
          *           soft    nofile     8192         # Open file descriptors (soft limit)
          *           soft    core       0            # Disable core dumps
          *           hard    core       0
          *           hard    nice       -19          # Prevent non-root users from low priority processes
          root        hard    nice       -20          # Root can run at minimal niceness

    # auditd - https://wiki.archlinux.org/title/Audit_framework
    - name: Enable auditd service
      ansible.builtin.systemd:
        name: auditd
        enabled: true
        state: started
      become: true

    - name: Configure audit rules
      # add manually first
      # list:
      # auditctl -l
      #
      # create:
      # auditctl -a always,exit -F arch=b64 -F path=/etc/passwd -F perm=rwxa
      #
      # verify:
      # augenrules --check
      # augenrules --load
      #
      # search:
      # ausearch -p 1
      #
      # audit:
      # aureport -n
      become: true
      ansible.builtin.copy:
        dest: /etc/audit/rules.d/mycustom.rules
        owner: root
        group: root
        mode: '0640'
        content: |
          # file
          -a always,exit -F arch=b64 -F path=/etc/passwd -F perm=rwxa
          -a always,exit -F arch=b64 -F path=/etc/shadow -F perm=rwxa
          -a always,exit -F arch=b64 -F path=/etc/group -F perm=rwxa
          -a always,exit -F arch=b64 -F path=/etc/ssh/sshd_config -F perm=rwxa
          -a always,exit -F arch=b64 -F path=/etc/sudoers -F perm=rwxa
          -a always,exit -F arch=b64 -F path=/etc/fstab -F perm=rwxa

          # dir
          -a always,exit -F arch=b64 -F dir=/boot
          -a always,exit -F arch=b64 -F dir=/etc/apparmor.d
          -a always,exit -F arch=b64 -F dir=/etc/network
          -a always,exit -F arch=b64 -F dir=/etc/sudoers.d
          -a always,exit -F arch=b64 -F dir=/etc/security
          -a always,exit -F arch=b64 -F dir=/etc/cron.d
          -a always,exit -F arch=b64 -F dir=/etc/cron.daily
          -a always,exit -F arch=b64 -F dir=/etc/cron.hourly
          -a always,exit -F arch=b64 -F dir=/etc/cron.monthly
          -a always,exit -F arch=b64 -F dir=/etc/cron.weekly

          # exe
          -a always,exit -F arch=b64 -F exe=/bin/su
          -a always,exit -F arch=b64 -F exe=/usr/bin/passwd
          -a always,exit -F arch=b64 -F exe=/usr/sbin/usermod
          -a always,exit -F arch=b64 -F exe=/usr/sbin/chsh
          -a always,exit -F arch=b64 -F exe=/usr/sbin/useradd
          -a always,exit -F arch=b64 -F exe=/usr/bin/sudo
          -a always,exit -F arch=b64 -F exe=/usr/sbin/sudo
          -a always,exit -F arch=b64 -F exe=/bin/chmod
          -a always,exit -F arch=b64 -F exe=/bin/chown

    # allow user to see audit logs
    - name: Ensure audit group exists
      group:
        name: audit
        state: present
      become: true

    - name: Add user to audit group
      ansible.builtin.user:
        name: "{{ ansible_env.USER }}"
        groups: audit
        append: true
      become: true

    - name: Configure audit logging behaviour
      become: true
      ansible.builtin.copy:
        dest: /etc/audit/auditd.conf
        owner: root
        group: root
        mode: '0640'
        content: |
          log_group = audit

    - name: Ensure apparmor notify config dir exists
      file:
        path: "/home/{{ ansible_env.USER }}/.config/autostart"
        state: directory
        mode: "0700"
        owner: "{{ ansible_env.USER }}"
        group: "{{ ansible_env.USER }}"
      become: true
      become_user: "{{ ansible_env.USER }}"
    - name: Configure apparmor desktop notify
      become: true
      ansible.builtin.copy:
        dest: "/home/{{ ansible_env.USER }}/.config/autostart/apparmor-notify.desktop"
        owner: "{{ ansible_env.USER }}"
        group: "{{ ansible_env.USER }}"
        mode: '0640'
        content: |
          [Desktop Entry]
          Type=Application
          Name=AppArmor Notify
          Comment=Receive on-screen notifications of AppArmor denials
          TryExec=aa-notify
          Exec=aa-notify -p -s 1 -w 60 -f /var/log/audit/audit.log
          StartupNotify=false
          NoDisplay=true

    - name: Enable apparmor service
      ansible.builtin.systemd:
        name: apparmor
        enabled: true
        state: started
      become: true

    # TODO
    # - name: Configure apparmor profiles
    #   # https://wiki.archlinux.org/title/AppArmor
    #   # aa-enabled
    #   # aa-status
    #   # aa-teardown ---> disables apparmor profiles
    #   sshd (SSH Daemon)
    #
    #   use audit logs to autogenerate:
    #   sudo aa-genprof [application-name]
    #   -> customize the profile, clean up
    #   sudo aa-complain /etc/apparmor.d/usr.bin.firefox
    #   sudo journalctl | grep apparmor
    #   sudo aa-enforce /etc/apparmor.d/usr.bin.[application-name]
# SYSTEMD SERVICES
# apache2 (Web Server)
# nginx (Web Server)
# mysql (Database Server)
# postgresql (Database Server)
# docker (Container Runtime)
# crond (Cron Scheduler)
# systemd-resolved (DNS Resolver)
# systemd-timesyncd (Time Synchronization)
# cupsd (Printing Service)
# networkd (Networking)
# lightdm (Display Manager, if using)
# ssh-agent (SSH Agent)
# firewalld (Firewall Service)
#
# OTHER APPS
# Firefox
# Chromium
# Brave
# Thunderbird
# Slack
# Discord
# Apache
# Nginx
# MySQL
# PostgreSQL
# sshd (SSH daemon)
# Docker
# VirtualBox
# QEMU
# Transmission (torrent client)
# Nextcloud Client
# Dropbox
# Nautilus (File Manager)
# Thunar (File Manager)
# Gedit (Text Editor)
# Vim (Text Editor)
# Bash (Shell)
# Zsh (Shell)
# cups (Printing Service)
# systemd (System Services)
# Cron (Scheduled Tasks)
# Mailman (Mailing List Manager)
# Telegram Desktop
#
# You would not need a profile for all systemd services by default, just the ones that:
# Handle remote access (e.g., sshd, docker)
# Handle sensitive data (e.g., mysql, postgresql)
# Interact with the network (e.g., systemd-resolved, networkd)
# Provide user-facing functionality (e.g., lightdm, cupsd)

    # USB GUARD
    # https://wiki.archlinux.org/title/USBGuard
    # to allow temp access:
    # sudo systemctl stop usbguard
    # or
    # sudo usbguard list-devices
    # sudo usbguard allow-device 123 --temporary
    - name: Configure usbguard
      become: true
      ansible.builtin.copy:
        dest: "/etc/usbguard/rules.conf"
        owner: "root"
        group: "root"
        mode: '0640'
        content: |
          # Allow input devices (keyboard, mouse)
          allow with-interface equals { 03:*:* }

          # Allow USB hubs (critical for docks)
          allow with-interface equals { 09:*:* }

          # Allow communication devices (USB ethernet adapters)
          allow with-interface equals { 02:*:* }

          # Allow audio devices (dock sound cards)
          allow with-interface equals { 01:*:* }

          # Allow video devices (webcams / display adapters)
          allow with-interface equals { 0e:*:* }

          # Allow miscellaneous composite devices (many USB-C docks)
          allow with-interface equals { ef:*:* }

          # Block mass storage (USB sticks)
          block with-interface equals { 08:*:* }

          # Block by default
          block

    - name: Enable usbguard
      become: true
      ansible.builtin.systemd:
        name: usbguard
        enabled: true
        state: started


    # TODO: arch-specific dotfiles -> dotfiles repo
    # TODO: dotfiles makefile, dot- prefix

  handlers:
    - name: Setup ntp
      ansible.builtin.command: timedatectl set-ntp true
      become: true

    - name: Restart journald
      ansible.builtin.systemd:
        name: systemd-journald
        enabled: true
        state: restarted
      become: true

    - name: Generate initramfs
      ansible.builtin.shell: mkinitcpio -P
      become: true

    - name: Restart docker
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: restarted
      become: true





